<!-- dashboard.html -->
<div class="container">
    <script type="text/javascript">

        // Resend e-mail verification
        function onClickEmailVerification() {
            sendEmailVerification("Resend Verification E-Mail",
                "Sent! If you dont see the E-Mail, check your spam folder.");
        }

        // Update the page layout depending on if the user has
        // verified their e-mail or not.
        function refreshLayout() {
            var user = firebase.auth().currentUser;
            if (user && user.emailVerified) {
                if (!$("#verify-email").hasClass("div-collapsed"))
                    $("#verify-email").addClass("div-collapsed");
                $("#dashboard-content").removeClass("div-collapsed");

            } else if (user) {
                if (!$("#dashboard-content").hasClass("div-collapsed"))
                    $("#dashboard-content").addClass("div-collapsed");
                $("#verify-email").removeClass("div-collapsed");
            }
            else { return; }
        }

        // Monitor for a change in currentUser.userVerified
        async function pollVerification() {
            var user = firebase.auth().currentUser;
            // If user logs out or becomes verified, break
            while (user != null && !user.emailVerified) {
                await sleep(3000);
                user = refreshCurrentUser();
            }
            // Change the dashboard's displayed layout
            refreshLayout();
        }

        //
        // Init Page
        //
        (function () {
            // Setup up the initial page layout
            refreshLayout();

            // Register event listeners
            $("#verify-email-button").bind("click", onClickEmailVerification);

            // Polls for a change in the currentUser's .emailVerified field.
            pollVerification();
        })();

        //
        // Init Firechat (not part of fabspa template)
        //
        (function() {
            var user = firebase.auth().currentUser;
            // Get a Firebase Database ref
            var chatRef = firebase.database().ref("firechat");

            // Create a Firechat instance
            var chat = new FirechatUI(chatRef, document.getElementById("firechat-wrapper"));
            
            // Set the Firechat user
            chat.setUser(user.uid, getCurrentUserDisplayName(), function(user) {
                chat.resumeSession();
            });
        })();
    </script>

    <div class="container-fluid">
        <!-- This is the section that is displayed if the user has not verified their e-mail -->
        <div id="verify-email" class="div-collapsed">
            <div class="d-flex justify-content-center">
                <h3>Please verify your e-mail address</h3>
            </div>
            <div class="d-flex justify-content-center">
                <a id="verify-email-button" class="btn btn-primary btn-outline-light" href="#">Resend Verification E-Mail</a>
            </div>
        </div>
        <!-- This is the section that is displayed if the user has verified their e-mail -->
        <div id="dashboard-content" class="div-collapse page-view">
            <div class="row">
                <div class="col-lg-8 d-none d-lg-block">
                    Welcome to the Dashboard.
                </div>
                <div class="col-lg-4 pt-3 pl-5">
                    <div id="chatbox" class="text-center">
                        <!-- This div is the target for wrapping firechat -->
                        <div id="firechat-wrapper" class="fluid-container">

                        </div>
                        <!-- Current user name or e-mail -->
                        <div id="user-info text-dark">
                            Logged in as
                            <span>{{ stateInformation.currentUser.email }}</span>.
                        </div>
                        <!-- Give credit to the developers of firechat -->
                        <a id="powered-by-firebase" href="https://firebase.google.com/?utm_source=firechat" target="_blank">
                            <img src="/img/firebase-logo.png" />
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>